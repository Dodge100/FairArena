/**
 * @license
 * Copyright (c) 2026 FairArena. All rights reserved.
 *
 * PROPRIETARY AND CONFIDENTIAL.
 *
 * This source code is the sole property of FairArena. Unauthorized copying,
 * distribution, or use of this file, via any medium, is strictly prohibited.
 *
 * This file and its contents are provided "AS IS" without warranty of any kind,
 * either express or implied, including, but not limited to, the implied
 * warranties of merchantability and fitness for a particular purpose.
 */





model Plan {
  id          String    @id @default(cuid())
  name        String    @unique
  planId      String    @unique
  amount      Int
  currency    String    @default("INR")
  credits     Int
  description String?
  features    String[]
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  payments    Payment[]

  @@index([planId])
  @@index([isActive])
  @@index([name])
}

model Payment {
  id                 String                @id @default(cuid())
  userId             String
  razorpayOrderId    String                @unique
  razorpayPaymentId  String?               @unique
  razorpaySignature  String?
  planId             String
  planName           String
  amount             Int
  currency           String                @default("INR")
  credits            Int
  status             PaymentStatus         @default(PENDING)
  paymentMethod      String?
  paymentContact     String?
  receipt            String?
  notes              Json?
  ipAddress          String?
  userAgent          String?
  idempotencyKey     String?               @unique
  webhookProcessed   Boolean               @default(false)
  webhookProcessedAt DateTime?
  failureReason      String?
  refundId           String?               @unique
  refundAmount       Int?
  refundReason       String?
  refundedAt         DateTime?
  createdAt          DateTime              @default(now())
  verifiedAt         DateTime? // When frontend verification occurred
  completedAt        DateTime? // When webhook confirmation occurred
  invoiceUrl         String?
  razorpayInvoiceId  String?               @unique
  creditTransactions CreditTransaction?
  plan               Plan                  @relation(fields: [planId], references: [planId])
  user               User                  @relation(fields: [userId], references: [userId])
  webhookEvents      PaymentWebhookEvent[]

  @@index([userId])
  @@index([razorpayOrderId])
  @@index([razorpayPaymentId])
  @@index([razorpayInvoiceId])
  @@index([status])
  @@index([createdAt])
  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([idempotencyKey])
  @@index([webhookProcessed])
  @@index([refundId])
  @@index([planId])
}

model CreditTransaction {
  id          String                @id @default(cuid())
  userId      String
  paymentId   String?               @unique
  amount      Int
  balance     Int
  type        CreditTransactionType
  description String
  metadata    Json?
  createdAt   DateTime              @default(now())
  payment     Payment?              @relation(fields: [paymentId], references: [id])
  user        User                  @relation(fields: [userId], references: [userId])

  @@index([userId])
  @@index([paymentId])
  @@index([type])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([userId, type])
  @@index([userId, type, createdAt])
}

model PaymentWebhookEvent {
  id              String    @id @default(cuid())
  paymentId       String?
  razorpayEventId String?   @unique
  eventType       String
  payload         Json
  signature       String?
  processed       Boolean   @default(false)
  processedAt     DateTime?
  errorMessage    String?
  retryCount      Int       @default(0)
  createdAt       DateTime  @default(now())
  payment         Payment?  @relation(fields: [paymentId], references: [id])

  @@index([paymentId])
  @@index([razorpayEventId])
  @@index([eventType])
  @@index([processed])
  @@index([createdAt])
  @@index([eventType, processed])
}
